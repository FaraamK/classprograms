/*SQL CODE FOR "Implementing Procedural Integrity" WORKSHOP, CURRENTLY UNFINISHED*/

CREATE TABLE EMP
(EMPNO VARCHAR2(5) PRIMARY KEY,
EMPNAME VARCHAR2(10) NOT NULL,
EMPSAL NUMBER,
EMPSUPV VARCHAR2(5) REFERENCES EMP(EMPNO));
/*creates emp table for trigger*/

CREATE OR REPLACE TRIGGER  SALARY_RESTRICT
FOR INSERT OR UPDATE ON EMP
COMPOUND TRIGGER
N_SAL NUMBER;
N_SUPV VARCHAR2(5);
SUPV_SAL NUMBER;
BEFORE EACH ROW IS
BEGIN
N_SAL := :NEW.EMPSAL;
N_SUPV := :NEW.EMPSUPV;
END BEFORE EACH ROW;
AFTER STATEMENT IS
BEGIN
IF N_SUPV IS NOT NULL THEN 
SELECT EMPSAL
INTO SUPV_SAL
FROM EMP
WHERE EMPNO = N_SUPV;
END IF;
IF(SUPV_SAL < N_SAL) THEN 
RAISE_APPLICATION_ERROR(-20064, 'INSERTED/UPDATED ROW HAS SALARY GREATER THEN SUPERVISOR');
END IF;
END AFTER STATEMENT;
END;

INSERT INTO EMP
VALUES ('A0001', 'MOE', 1000, NULL);
INSERT INTO EMP
VALUES ('A0002', 'LARRY', 900, 'A0001');
INSERT INTO EMP
VALUES ('A0003', 'CURLY', 750, 'A0002');
INSERT INTO EMP
VALUES ('A0004', 'SHEMP', 1250, 'A0001');

UPDATE EMP SET EMPSAL = 1000 WHERE EMPNO = 'A0003';
